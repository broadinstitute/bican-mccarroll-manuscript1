% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/differential_expression.R
\name{should_skip_dream_subset}
\alias{should_skip_dream_subset}
\title{Decide whether to skip a dream fit due to insufficient or unstable data}
\usage{
should_skip_dream_subset(
  full_form,
  samp,
  min_n = 50,
  min_df_resid = 5,
  max_kappa = 1e+10
)
}
\arguments{
\item{full_form}{A formula including both fixed and random effects, exactly
as passed to \code{variancePartition::dream()}.}

\item{samp}{A \code{data.frame} of sample-level metadata (typically
\code{dge$samples}) containing all variables referenced in \code{full_form}.}

\item{min_n}{Integer. Minimum number of observations required after NA
filtering to attempt a fit. Subsets with fewer observations are skipped.
Default is \code{50}.}

\item{min_df_resid}{Integer. Minimum residual degrees of freedom
(\code{n - p}) required for a stable fit, where \code{p} is the number of
fixed-effect columns in the design matrix. Default is \code{5}.}

\item{max_kappa}{Numeric. Maximum allowed condition number for the fixed-effect
design matrix. Larger values indicate near-collinearity and an ill-conditioned
fit. Default is \code{1e10}.}
}
\value{
A named list with elements:
\describe{
  \item{skip}{Logical. \code{TRUE} if the fit should be skipped.}
  \item{reason}{Character. Human-readable explanation for skipping, or
    empty string if \code{skip == FALSE}.}
  \item{n}{Integer. Number of observations used after NA filtering.}
  \item{p}{Integer. Number of fixed-effect columns in the design matrix.}
  \item{df_resid}{Integer. Residual degrees of freedom (\code{n - p}).}
  \item{kappa}{Numeric. Estimated condition number of the design matrix, or
    \code{NA} if not computed.}
}
}
\description{
This helper performs pre-flight checks on a candidate
`variancePartition::dream` model to determine whether the subset of samples
is large and well-conditioned enough to support a stable fit. The checks are
intentionally conservative and are designed to catch cases that otherwise
fail at fit time.
}
\details{
The function operates on the *effective* dataset used by the model, defined
as \code{model.frame(full_form, data, na.action = na.omit)}. All criteria are
evaluated after NA filtering and factor level dropping implicitly performed
by the model frame.


Passing a full-rank check alone is not sufficient to guarantee a stable
mixed-model fit in small, heavily stratified subsets. This function augments
rank checks with explicit constraints on sample size, residual degrees of
freedom, and numerical conditioning of the fixed-effect design matrix.

Typical usage is to call this function immediately after constructing the
full model formula and before running \code{voomWithDreamWeights()} or
\code{dream()}. Subsets that fail the checks can be skipped or rerouted to a
simplified model.
}
\examples{
chk <- should_skip_dream_subset(full_form, dge$samples, min_n = 50)
if (chk$skip) {
    message("Skipping fit: ", chk$reason)
} else {
    # proceed with voom/dream
}

}
\seealso{
\code{\link[variancePartition]{dream}}
}
