% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/mashR.R
\name{fit_mash_two_stage}
\alias{fit_mash_two_stage}
\title{Two-stage mash fit: learn covariances on informative rows, then apply to all genes}
\usage{
fit_mash_two_stage(
  Bhat,
  Shat,
  npc = 5,
  only_cannonical_matrixes = FALSE,
  huge = 1e+05,
  usepointmass = TRUE
)
}
\arguments{
\item{Bhat}{numeric matrix (genes x conditions) of effect estimates}

\item{Shat}{numeric matrix (genes x conditions) of standard errors}

\item{npc}{integer; number of PCs to pass to cov_pca (capped at ncol(Bhat))}

\item{only_cannonical_matrixes}{logical; if TRUE use only canonical covariances (no ED_tPCA)}

\item{huge}{numeric; SE threshold used to define "well-measured" rows (exclude rows with any SE >= huge)}

\item{usepointmass}{logical; include a point-mass-at-0 component}

\item{grid}{numeric vector; scale grid passed to \code{mash} (set to \code{NULL} to use mash defaults)}

\item{autoselect.grid}{logical; passed to \code{mash}; default FALSE to enforce the provided grid}
}
\value{
list with elements:
  \item{m_learn}{mash fit on informative rows (learned prior)}
  \item{m}{final mash fit on all rows using the learned prior}
  \item{learn_rows}{integer indices of rows used for learning}
  \item{well_measured}{logical vector marking rows with all SE < huge}
  \item{strong_idx_w}{logical vector (within well_measured subset) chosen by choose_strong_rows}
  \item{Ulist}{covariance library used}
  \item{grid}{scale grid actually used}
}
\description{
Two-stage mash fit: learn covariances on informative rows, then apply to all genes
}
\details{
Stage 1 learns the mixture on rows that are both well-measured and strong.
Stage 2 applies the learned prior to all genes, preventing missing/huge-SE rows
from steering the covariance learning. A floor on the scale grid helps avoid
soaking up tiny correlated drift with a structured component.
}
