% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/age_model_fit_core.R
\name{compute_final_residuals_repeated_splits}
\alias{compute_final_residuals_repeated_splits}
\title{Compute donor residuals using repeated stratified 80/20 splits}
\usage{
compute_final_residuals_repeated_splits(
  dge_cell,
  age_col = "age",
  donor_col = "donor",
  n_bins = 5,
  test_prop = 0.2,
  n_repeats = 100,
  optimize_alpha = FALSE,
  alpha_fixed = 0.5,
  alpha_grid = seq(0, 1, by = 0.1),
  seed = 1,
  prior.count = 1,
  verbose_every = 10
)
}
\arguments{
\item{dge_cell}{A donor-level \code{DGEList} (one sample per donor), typically
produced by collapsing multiple observations per donor.}

\item{age_col}{Column name in \code{dge_cell$samples} containing donor age.}

\item{donor_col}{Column name in \code{dge_cell$samples} containing donor IDs.}

\item{n_bins}{Number of age quantile bins used for stratified splitting.}

\item{test_prop}{Fraction of donors assigned to the test set in each repeat.}

\item{n_repeats}{Integer; number of repeated splits to perform.}

\item{optimize_alpha}{Logical; if \code{TRUE}, fit each split using
\code{train_enet_cv_optimize_alpha(..., compute_oof = FALSE)}. If \code{FALSE},
use \code{train_enet_cv(..., compute_oof = FALSE)} with \code{alpha_fixed}.}

\item{alpha_fixed}{Elastic net alpha used when \code{optimize_alpha = FALSE}.}

\item{alpha_grid}{Numeric vector of candidate alpha values used when
\code{optimize_alpha = TRUE}.}

\item{seed}{Integer seed controlling the sequence of splits and model fitting.
Each repeat uses \code{seed + mc_iter - 1}.}

\item{prior.count}{Prior count passed to \code{predict_age_from_dge()}.}

\item{verbose_every}{Integer; if positive, log progress every
\code{verbose_every} repeats.}
}
\value{
A list with:
\itemize{
  \item \code{donor_oof_predictions}: long-format data.frame with one row per
    held-out donor per repeat, containing \code{donor}, \code{age}, \code{pred},
    \code{resid} (pred - age), and \code{mc_iter}.
  \item \code{donor_residual_summary}: data.frame with one row per donor,
    containing \code{age}, \code{n_oof}, \code{pred_mean}, \code{resid_mean},
    \code{resid_median}, and \code{resid_sd}.
  \item \code{per_repeat_metrics}: data.frame of metrics for each repeat split.
  \item \code{avg_pred_metrics}: metrics computed using per-donor average
    predictions (\code{pred_mean}) across repeats.
  \item \code{params}: list of the key parameter values used.
}
}
\description{
Runs repeated Monte Carlo cross-validation by repeatedly splitting donors into
stratified train/test sets, fitting an age model on the training donors, and
predicting ages for held-out donors. For each donor, out-of-fold (held-out)
predictions are accumulated across repeats, enabling per-donor residual
summaries and stability estimates with respect to training-set composition.
}
\details{
This function is intended to produce donor-level residuals for downstream
biological interpretation (e.g., "older/younger than chronological age") while
reducing dependence on any single fold assignment.
}
